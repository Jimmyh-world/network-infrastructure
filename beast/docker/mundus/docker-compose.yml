version: '3.8'

networks:
  mundus:
    driver: bridge

services:
  # Mono-Container: Backend API + Frontend (React/Vite)
  # Combines backend (Express) and frontend (React/Vite) in single container
  # Serves both API endpoints and static frontend files from port 3001
  mundus:
    build:
      context: /home/jimmyb/Mundus-editor-application
      dockerfile: docker/services/mono.Dockerfile
      args:
        CACHE_BUST: ${CACHE_BUST:-default}
        VITE_SUPABASE_URL: https://zofcfcclhaqvqdytarxe.supabase.co
        VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvZmNmY2NsaGFxdnFkeXRhcnhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MTg3NzUsImV4cCI6MjA3NDE5NDc3NX0.VXx4brC-2TuUmh-A7PqzvBblUSWRyYQvnh5lBj8kDEQ
    container_name: mundus
    restart: unless-stopped
    ports:
      - "8081:3000"  # Port 8081 external (Cloudflare Tunnel), 3000 internal (Express)
    env_file:
      - .env.backend  # Backend configuration from Vault
      - .env.frontend  # Frontend Supabase credentials
    volumes:
      - ./.env.backend:/app/config/config.env:ro  # Mount env file to config path
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/v2/articles?limit=1', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s
    networks:
      - mundus
